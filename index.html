<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚…åŸæœƒè­°å®¤é ç´„ç³»çµ± - 2025æ–°ç‰ˆ
    </title>
    <script type="module">
        let isAdmin = false;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAw3jQ3tQ4FqMvuW2yK_ziK8X17FxuPUkI",
            authDomain: "ratocar-4e2ea.firebaseapp.com",
            databaseURL: "https://ratocar-4e2ea-default-rtdb.firebaseio.com",
            projectId: "ratocar-4e2ea",
            storageBucket: "ratocar-4e2ea.firebasestorage.app",
            messagingSenderId: "798151277741",
            appId: "1:798151277741:web:b1774d7e5449303845da24",
            measurementId: "G-G7BBW1XSGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const recordsRef = ref(db, 'records');

        const users = [
            "å³å¾·å®", "ç‹æ¸…é´»", "ç•™ç‘è“®", "æå®¶ç¶­", "ææ»‹èŠ³", "åŠ‰ä¿Šå½¥",  "å» å•†", "å…¶ä»–", "ç®¡ç†è€…"  // 
        ];

    let finalSelectedUser = ""; 
let finalEndTime = null;   

function reserveForFuture() {
    if (!finalSelectedUser || !finalEndTime) {
        alert("è«‹å…ˆå¥—ç”¨ä½¿ç”¨è€…èˆ‡æ™‚é–“ï¼");
        return;
    }

    const roomId = prompt("è«‹è¼¸å…¥è¦é ç´„çš„æœƒè­°å®¤ç·¨è™Ÿï¼ˆä¾‹å¦‚ï¼š102ï¼‰ï¼š");
    if (!roomId || !document.getElementById(roomId)) {
        alert("ç„¡æ•ˆçš„æœƒè­°å®¤ ID");
        return;
    }

    const selectedYear = document.getElementById("yearSelect").value;
    const month = document.getElementById("monthSelect").value;
    const day = document.getElementById("daySelect").value;
    const startHour = document.getElementById("startHour").value;
    const startMinute = document.getElementById("startMinute").value;
    const endHour = document.getElementById("endHour").value;
    const endMinute = document.getElementById("endMinute").value;

    const today = new Date();
    const year = today.getFullYear();
    const startTime = new Date(selectedYear, month - 1, day, startHour, startMinute);
    const endTime = new Date(selectedYear, month - 1, day, endHour, endMinute);

    const formattedStartTime = `${selectedYear}-${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')} ${startHour}:${startMinute}`;
    const formattedEndTime = `${selectedYear}-${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')} ${endHour}:${endMinute}`;

    
    const reservationData = {
        roomId: roomId,
        user: finalSelectedUser,
        startTime: formattedStartTime,  // ä½¿ç”¨æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
        endTime: formattedEndTime,      // ä½¿ç”¨æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
    };

    const futureRef = ref(db, `futureReservations/${roomId}_${new Date(selectedYear, month - 1, day, startHour, startMinute).getTime()}`);
    set(futureRef, reservationData)
        .then(() => {
            alert("âœ… å·²é ç´„æˆåŠŸï¼");
            loadFutureReservations(); 
        })
        .catch(err => {
            alert("é ç´„å¤±æ•—ï¼š" + err);
        });
}
function loadFutureReservations() {
    const listElem = document.getElementById("futureReservationsList");
    listElem.innerHTML = "";

    const futureRef = ref(db, 'futureReservations');
    onValue(futureRef, snapshot => {
        const data = snapshot.val();
        if (!data) return;

        const now = Date.now();
        const currentUser = document.getElementById("userSelect").value;

        const sorted = Object.entries(data).sort((a, b) => {
            return new Date(a[1].startTime) - new Date(b[1].startTime);
        });

        sorted.forEach(([key, res]) => {
            const li = document.createElement("li");

            const start = new Date(res.startTime);
            const options = {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const localTime = start.toLocaleString('zh-TW', options);

            const end = new Date(res.endTime);

            const year = start.getFullYear();
            const month = (start.getMonth() + 1).toString().padStart(2, '0');
            const date = start.getDate().toString().padStart(2, '0');
            const startHour = start.getHours().toString().padStart(2, '0');
            const startMin = start.getMinutes().toString().padStart(2, '0');
            const endHour = end.getHours().toString().padStart(2, '0');
            const endMin = end.getMinutes().toString().padStart(2, '0');

            const fullDateStr = `${res.startTime}~${res.endTime}`;
            const friendlyStart = `${res.startTime}`;
            
            li.textContent = `æœƒè­°å®¤${res.roomId} - ${res.user} - ${fullDateStr}ï¼ˆé–‹å§‹æ™‚é–“${friendlyStart}ï¼‰`;



            if (isAdmin) {
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "åˆªé™¤";
                deleteBtn.style.marginLeft = "10px";

                deleteBtn.onclick = function () {
                    const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥åˆªé™¤é ç´„ï¼š");
                    if (password === "Onano_Nb") {
                        remove(ref(db, `futureReservations/${key}`))
                            .then(() => {
                                alert("âœ… é ç´„å·²åˆªé™¤");
                                loadFutureReservations(); 
                            })
                            .catch(err => {
                                alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + err);
                            });
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                    }
                };

                li.appendChild(deleteBtn);
            }

            listElem.appendChild(li);
        });
    });
}

function monitorFutureReservations() {
    setInterval(() => {
        const now = new Date();

        const futureRef = ref(db, 'futureReservations');
        get(futureRef).then(snapshot => {
            const data = snapshot.val();
            if (!data) return;

            Object.entries(data).forEach(([key, res]) => {
                const startTime = new Date(res.startTime);

                if (now >= startTime) {
                    const roomId = res.roomId;
                    const cell = document.getElementById(roomId);

                    if (cell && cell.classList.contains('green')) {
                        cell.classList.remove('green');
                        cell.classList.add('red');
                        cell.textContent = `${roomId} - ${res.user}`;

                        const colorRef = ref(db, roomId);
                        set(colorRef, {
                            color: 'red',
                            user: res.user,
                            endTime: res.endTime
                        });

                        push(recordsRef, {
                            id: roomId,
                            action: 'ä½¿ç”¨ä¸­ï¼ˆè‡ªå‹•ï¼‰',
                            user: res.user,
                            time: new Date().toISOString(),
                            endTime: res.endTime
                        });
                        remove(ref(db, `futureReservations/${key}`));
                    }
                }
            });
        });
    }, 10000); //æ¯10ç§’æª¢æŸ¥æ™‚é–“å»æ”¹è®Šæ ¼å­ç‹€æ…‹
}

function populateTimeSelectors() {
    const startHour = document.getElementById("startHour");
    const startMinute = document.getElementById("startMinute");
    const endHour = document.getElementById("endHour");
    const endMinute = document.getElementById("endMinute");

    [startHour, startMinute, endHour, endMinute].forEach(select => select.innerHTML = "");

    for (let h = 8; h < 20; h++) {
        const hStr = h.toString().padStart(2, '0');
        const opt1 = new Option(hStr, hStr);
        const opt2 = new Option(hStr, hStr);
        startHour.appendChild(opt1);
        endHour.appendChild(opt2);
    }

    for (let m = 0; m < 60; m++) {
        const mStr = m.toString().padStart(2, '0');
        const opt1 = new Option(mStr, mStr);
        const opt2 = new Option(mStr, mStr);
        startMinute.appendChild(opt1);
        endMinute.appendChild(opt2);
    }
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const daySelect = document.getElementById("daySelect");

    yearSelect.innerHTML = "";
    monthSelect.innerHTML = "";
    daySelect.innerHTML = "";

    for (let y = 2025; y <= 2050; y++) {
    yearSelect.appendChild(new Option(y.toString(), y.toString()));
    }
    for (let m = 1; m <= 12; m++) {
        const mm = m.toString().padStart(2, '0');
        monthSelect.appendChild(new Option(mm, mm));
    }
    for (let d = 1; d <= 31; d++) {
        const dd = d.toString().padStart(2, '0');
        daySelect.appendChild(new Option(dd, dd));
    }
}
        
const applyCustomUserAndTime = () => {
    console.log("applyCustomUserAndTime triggered"); 

    const dropdownUser = document.getElementById("userSelect").value;
    const customName = document.getElementById("customUserInput").value.trim();

    const month = document.getElementById("monthSelect").value;
    const day = document.getElementById("daySelect").value;
    const startHour = document.getElementById("startHour").value;
    const startMinute = document.getElementById("startMinute").value;
    const endHour = document.getElementById("endHour").value;
    const endMinute = document.getElementById("endMinute").value;

    if (dropdownUser === "å…¶ä»–") {
        if (!customName) {
            alert("è«‹è¼¸å…¥åç¨±ï¼Œä¾‹å¦‚ï¼šç‹å¤§æ˜");
            return;
        }
    } else {
        if (!dropdownUser || dropdownUser === "") {
            alert("è«‹é¸æ“‡ä½¿ç”¨è€…åç¨±");
            return;
        }
    }

    const user = dropdownUser === "å…¶ä»–" ? customName : dropdownUser;
    const fullStartTimeString = `${selectedYear}-${parseInt(month).toString().padStart(2, '0')}-${parseInt(day).toString().padStart(2, '0')} ${startHour}:${startMinute}`;
    const fullEndTimeString = `${selectedYear}-${parseInt(month).toString().padStart(2, '0')}-${parseInt(day).toString().padStart(2, '0')} ${endHour}:${endMinute}`;
    const finalUserInfo = `${user} - ${fullTimeString}`;

    const selectedYear = document.getElementById("yearSelect").value;
    if (!month || !day || !startHour || !startMinute || !endHour || !endMinute) {
        alert("è«‹å®Œæ•´é¸æ“‡æ™‚é–“ï¼ˆæœˆä»½ã€æ—¥æœŸã€é–‹å§‹æ™‚é–“ã€çµæŸæ™‚é–“ï¼‰");
        return;
    }

    const formattedStartTime = `${selectedYear}-${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')} ${startHour}:${startMinute}`;
    const formattedEndTime = `${selectedYear}-${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')} ${endHour}:${endMinute}`;
    
    const reservationData = {
        roomId: roomId,
        user: finalSelectedUser,
        startTime: formattedStartTime,  // ä½¿ç”¨æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
        endTime: formattedEndTime,      // ä½¿ç”¨æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
    };
    
    finalEndTime = new Date(
        parseInt(selectedYear),
        parseInt(month) - 1,
        parseInt(day),
        parseInt(endHour),
        parseInt(endMinute)
    );

    finalSelectedUser = finalUserInfo;

    localStorage.setItem("selectedUser", finalUserInfo);

    alert(`âœ… å·²å¥—ç”¨ï¼š${finalUserInfo}`);

    const infoElem = document.getElementById("currentUserInfo");
    if(infoElem){
        infoElem.textContent = `å·²å¥—ç”¨ä½¿ç”¨è€…ï¼š${finalUserInfo}`;
        infoElem.style.color = "green";
    }
}
window.applyCustomUserAndTime = applyCustomUserAndTime;

        window.onload = function() {
            const userSelect = document.getElementById("userSelect");
            users.forEach(user => {
                const option = document.createElement("option");
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
            populateTimeSelectors();
            const savedUser = localStorage.getItem("selectedUser");
            if (savedUser) {
                document.getElementById("currentUserInfo").textContent = `å·²å¥—ç”¨ï¼š${savedUser}`;
            }

            const customInput = document.getElementById("customUserInput");
            customInput.disabled = true; // åˆå§‹ç‚ºé—œé–‰
            userSelect.addEventListener("change", (e) => {
    const selectedUser = e.target.value;
    if (selectedUser === "ç®¡ç†è€…") {
        const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥é¸æ“‡ç®¡ç†è€…:");
        if (password === "Onano_Nb") {
            localStorage.setItem("selectedUser", selectedUser);
            e.target.value = "ç®¡ç†è€…";
            isAdmin = true; 
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            e.target.value = "";
            isAdmin = false;
        }
    } else {
        localStorage.setItem("selectedUser", selectedUser);
        isAdmin = false;
    }

            if (selectedUser === "å…¶ä»–") {
        customInput.disabled = false;
        customInput.focus();
    } else {
        customInput.disabled = true;
        customInput.value = "";
    }

    loadFutureReservations(); 
});

            updateBlockStatus(); 
            displayDateTime();
            loadFutureReservations();
            monitorFutureReservations();

        setInterval(displayDateTime, 1000);
        };

        function displayDateTime() {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };

            const dateTime = now.toLocaleString('zh-TW', options);
            document.getElementById('datetime').textContent = dateTime;
        }

        function updateBlockStatus() {
            const allCells = document.querySelectorAll('td');
            allCells.forEach(cell => {
                const id = cell.id;
                const colorRef = ref(db, id);
                onValue(colorRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        cell.classList.remove('green', 'red');
                        cell.classList.add(data.color);
                        if (data.color === 'red') {
                            cell.textContent = `${id} - ${data.user}`;
                        } else {
                            cell.textContent = `${id}`;
                        }
                    } else {
                        cell.classList.remove('green', 'red');
                        cell.classList.add('green');
                        cell.textContent = `${id}`;
                    }
                });
            });
        }
        function toggleColor(element) {
            const id = element.id;

            if(!finalSelectedUser){
                alert("è«‹å…ˆå¥—ç”¨ä½¿ç”¨è€…åç¨±èˆ‡æ™‚é–“ï¼");
                return;
            }

            const colorRef = ref(db, id);

            if (element.classList.contains('green')) {
                element.classList.remove('green');
                element.classList.add('red');
                // 
                element.textContent = `${id} - ${finalSelectedUser}`;

                const newRecord = {
                    id: id,
                    action: 'ä½¿ç”¨ä¸­',
                    user: finalSelectedUser,
                    time: new Date().toISOString(),
                    endTime: finalEndTime ? finalEndTime.toISOString() : null
                };

                set(colorRef, {
                    color: 'red',
                    user: finalSelectedUser,
                    endTime: finalEndTime ? finalEndTime.toISOString() : null
                });

                push(recordsRef, newRecord);

            } else if (element.classList.contains('red')) {
                element.classList.remove('red');
                element.classList.add('green');
                element.textContent = id;

                set(colorRef, { color: 'green' });

                push(recordsRef, {
                    id: id,
                    action: 'ç©ºé–’',
                    user: finalSelectedUser,
                    time: new Date().toISOString()
                });
            }
        }

        function showRecords() {
            const recordList = document.getElementById("recordList");
            const carNumberInput = document.getElementById("carNumberInput");
            const userSelect = document.getElementById("userSelect");
            const selectedUser = userSelect.value;

            const carNumber = carNumberInput.value.trim().toLowerCase();

            onValue(recordsRef, (snapshot) => {
                const records = snapshot.val();
                if (!records) return;

                const filteredRecords = Object.entries(records)
                    .filter(([key, record]) => {
                        const recordDate = new Date(record.time);
                        const recordDateStr = recordDate.toISOString().split('T')[0];

                        const isCarNumberMatch = carNumber === "" || record.id.toLowerCase().includes(carNumber);
                        const isUserMatch = selectedUser === "ç®¡ç†è€…" || record.user === selectedUser;

                        return isCarNumberMatch && isUserMatch;
                    })
                    .reverse();

                recordList.innerHTML = ''; 

                filteredRecords.forEach(([key, record]) => {
                    const recordItem = document.createElement("li");
                    const recordTime = new Date(record.time);
                    const options = {
                        timeZone: 'Asia/Taipei',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };
                    const localTime = recordTime.toLocaleString('zh-TW', options);

                    recordItem.textContent = `${record.id} - ${record.action} (${record.user}) - ${localTime}`;

                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "åˆªé™¤";
                    deleteButton.onclick = function() {
                        const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥åˆªé™¤ç´€éŒ„:");
                        if (password === "Onano_Nb") {
                            remove(ref(db, 'records/' + key)).then(() => {
                                alert("ç´€éŒ„å·²åˆªé™¤ï¼");
                                showRecords();  
                            }).catch((error) => {
                                alert("åˆªé™¤å¤±æ•—ï¼š" + error);
                            });
                        } else {
                            alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                        }
                    };

                    recordItem.appendChild(deleteButton);
                    recordList.appendChild(recordItem);
                });
            });
        }

        window.toggleColor = toggleColor;
        window.showRecords = showRecords;
        window.reserveForFuture = reserveForFuture;
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-image: url('https://i.meee.com.tw/445Ea5W.png');
            background-size: cover;
            background-attachment: fixed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
        }
        .green {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .red {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
        }
        .first-row td {
            width: 16.6%;
            height: 60px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .second-row td {
            width: 12.5%;
            height: 60px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        h1 {
            font-family: 'DFKai-SB', "æ¨™æ¥·é«”", serif;
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }
        #datetime {
            font-size: 18px;
            font-family: 'Arial', sans-serif;
            margin-left: 20px;
        }
        select {
            margin: 20px 0;
        }
        #recordList {
            margin-top: 20px;
            padding: 0;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        button {
            cursor: pointer;
            margin-top: 10px;
        }
        #systemImage {
            display: block;
            margin: 20px auto;
            max-width: 10%;
            height: auto;
        }
        #newsTicker {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
        }
        #newsTicker span {
            display: inline-block;
            padding-right: 100%;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        #customUserInput {
        width: 180px;
        padding: 5px;
        font-size: 14px;
        }

    </style>
</head>
<body>

    <h1>
        æ‚…åŸæœƒè­°å®¤é ç´„ç³»çµ±
    </h1>

    <h1>
        âŒš<span id="datetime"></span>
    </h1>

    <a href="http://www.onano-nm.com/">
        <img id="systemImage" src="https://i.meee.com.tw/VFCitmP.png" alt="æ‚…åŸæœƒè­°å®¤é ç´„ç³»çµ±åœ–ç‰‡" />
    </a>
<div>
    <div>
    <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ é ç´„æœƒè­°å®¤</h2>
    <ul id="futureReservationsList"></ul>
</div>
    <label for="userSelect">é¸æ“‡ç”¨æˆ¶: </label>
    <select id="userSelect">
        <option value="">è«‹é¸æ“‡</option>
    </select>

    <input type="text" id="customUserInput" placeholder="è«‹å…ˆé»é¸:å…¶ä»–~æ‰å¯è¼¸å…¥åç¨±" />
    <div>
    <label for="yearSelect">å¹´ä»½ï¼š</label>
    <select id="yearSelect"></select>
        
    <label for="monthSelect">æœˆä»½ï¼š</label>
    <select id="monthSelect"></select>

    <label for="daySelect">æ—¥æœŸï¼š</label>
    <select id="daySelect"></select>
    </div>

    <div>
    <label for="startHour">é–‹å§‹æ™‚é–“ï¼š</label>
    <select id="startHour"></select> :
    <select id="startMinute"></select>

    <label for="endHour">çµæŸæ™‚é–“ï¼š</label>
    <select id="endHour"></select> :
    <select id="endMinute"></select>
    <button onclick="applyCustomUserAndTime()">å¥—ç”¨</button>
    <button onclick="reserveForFuture()">é ç´„</button>
    <p id="currentUserInfo" style="margin-top: 10px;"></p>
    </div>
</div>

    <div id="newsTicker">
        <span>æœ€æ–°æ¶ˆæ¯: è«‹åŒä»è¸´èºä½¿ç”¨!!</span>
    </div>

    <h2>å°å‹æœƒè­°å®¤(å¯å®¹ç´4~5äºº)</h2>
    <table class="first-row">
        <tr>
            <td class="green" id="102" onclick="toggleColor(this)">102</td>
            <td class="green" id="103" onclick="toggleColor(this)">103</td>
            <td class="green" id="104" onclick="toggleColor(this)">104</td>
            <td class="green" id="107" onclick="toggleColor(this)">107</td>
            <td class="green" id="108" onclick="toggleColor(this)">108</td>
        </tr>
    </table>

    <h2>ä¸­å‹æœƒè­°å®¤(å¯å®¹ç´6~10äºº)</h2>
    <table class="second-row">
        <tr>
            <td class="green" id="105" onclick="toggleColor(this)">105</td>
            <td class="green" id="106" onclick="toggleColor(this)">106</td>
            <td class="green" id="A01" onclick="toggleColor(this)">A01</td>
            <td class="green" id="A02" onclick="toggleColor(this)">A02</td>
        </tr>
    </table>

    <h2>å¤§å‹æœƒè­°å®¤(å¯å®¹ç´10~12äºº)</h2>
    <table class="second-row">
        <tr>
            <td class="green" id="101" onclick="toggleColor(this)">101</td>
        </tr>
    </table>

    <div>
        <label for="carNumberInput">æœå°‹é ç´„:</label>
        <input type="text" id="carNumberInput" placeholder="è¼¸å…¥æœƒè­°å®¤ID...">
    </div>

    <button onclick="showRecords()">é¡¯ç¤ºç´€éŒ„</button>

    <ul id="recordList"></ul>

</body>
</html>

























