<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>悅城會議室預約系統:小劉製
    </title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
        let customUserWithTime = ""; // 全域變數儲存輸入的結果
let customEndTime = null;

function applyUserWithTime() {
    const userInput = document.getElementById("customUserInput").value.trim();
    const timeInput = document.getElementById("customTimeInput").value.trim();

    if (!userInput || !timeInput) {
        alert("請輸入使用者名稱和時間！");
        return;
    }

    const timePattern = /^(\d{2}:\d{2})~(\d{2}:\d{2})$/;
    const match = timeInput.match(timePattern);

    if (!match) {
        alert("時間格式錯誤，請使用 09:00~11:00 格式");
        return;
    }

    const today = new Date();
    const endTimeStr = match[2]; // 取結束時間部分
    const [endHour, endMinute] = endTimeStr.split(":");
    const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, endMinute);

    customUserWithTime = `${userInput} - ${timeInput}`;
    customEndTime = endTime;

    localStorage.setItem("selectedUser", customUserWithTime);

    alert(`已套用：${customUserWithTime}`);
}

        const firebaseConfig = {
            apiKey: "AIzaSyAw3jQ3tQ4FqMvuW2yK_ziK8X17FxuPUkI",
            authDomain: "ratocar-4e2ea.firebaseapp.com",
            databaseURL: "https://ratocar-4e2ea-default-rtdb.firebaseio.com",
            projectId: "ratocar-4e2ea",
            storageBucket: "ratocar-4e2ea.firebasestorage.app",
            messagingSenderId: "798151277741",
            appId: "1:798151277741:web:b1774d7e5449303845da24",
            measurementId: "G-G7BBW1XSGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const recordsRef = ref(db, 'records');

        const users = [
            "吳德宏", "王清鴻", "留瑞蓮", "李家維", "李滋芳", "劉俊彥",  "廠商", "其他", "管理者"  // 
        ];

        function addCustomUser() {
    const input = document.getElementById("customUserInput");
    const userSelect = document.getElementById("userSelect");
    const name = input.value.trim();
    if (!name) {
        alert("請輸入名稱");
        return;
    }

            function applyCustomTime() {
    const timeInput = document.getElementById("customTimeInput").value.trim();
    const userSelect = document.getElementById("userSelect");
    let selectedUser = userSelect.value;

    if (!selectedUser) {
        alert("請先選擇使用者！");
        return;
    }

    if (!timeInput) {
        alert("請輸入使用時間！");
        return;
    }

    // 移除舊的時間部分（如果有）
    const nameOnly = selectedUser.split('(')[0].trim();

    const newName = `${nameOnly} (${timeInput})`;

    // 替換下拉選項
    const options = userSelect.options;
    for (let i = 0; i < options.length; i++) {
        if (options[i].value === selectedUser) {
            options[i].value = newName;
            options[i].textContent = newName;
            userSelect.value = newName;
            localStorage.setItem("selectedUser", newName);
            break;
        }
    }

    document.getElementById("customTimeInput").value = "";
}

    // 檢查是否已存在
    for (let i = 0; i < userSelect.options.length; i++) {
        if (userSelect.options[i].value === name) {
            userSelect.value = name;
            localStorage.setItem("selectedUser", name);
            input.value = "";
            return;
        }
    }

    // 加入新項目
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    userSelect.appendChild(option);
    userSelect.value = name;
    localStorage.setItem("selectedUser", name);
    input.value = "";
}
    let finalSelectedUser = ""; // 存儲目前選擇的使用者資訊
let finalEndTime = null;    // 存儲結束時間

function applyCustomUserAndTime() {
    const dropdownUser = document.getElementById("userSelect").value.trim();
    const customName = document.getElementById("customUserInput").value.trim();
    const timeInput = document.getElementById("customTimeInput").value.trim();

    if (!dropdownUser && !customName) {
        alert("請選擇或輸入使用者名稱");
        return;
    }

    if (!timeInput) {
        alert("請輸入使用時間，例如：0921 09:00~11:00 或 09:00~11:00");
        return;
    }

    const dateTimePattern = /^(\d{4})?\s?(\d{2}:\d{2})~(\d{2}:\d{2})$/;
    const match = timeInput.match(dateTimePattern);
    if (!match) {
        alert("時間格式錯誤，請使用 0921 09:00~11:00 或 09:00~11:00 格式");
        return;
    }

    const [_, datePart, startTime, endTime] = match;

    // 組合名稱
    const user = customName || dropdownUser;
    const fullTimeString = datePart ? `${datePart} ${startTime}~${endTime}` : `${startTime}~${endTime}`;
    const finalUserInfo = `${user} - ${fullTimeString}`;

    // 計算結束時間，儲存用
    const today = new Date();
    const endHour = parseInt(endTime.split(":")[0], 10);
    const endMinute = parseInt(endTime.split(":")[1], 10);
    finalEndTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, endMinute);

    // 儲存
    finalSelectedUser = finalUserInfo;
    localStorage.setItem("selectedUser", finalUserInfo);

    alert(`✅ 已套用：${finalUserInfo}`);
}
        window.onload = function() {
            const userSelect = document.getElementById("userSelect");
            users.forEach(user => {
                const option = document.createElement("option");
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });

            const savedUser = localStorage.getItem("selectedUser");
            if (savedUser) {
                userSelect.value = savedUser;
            }

            userSelect.addEventListener("change", (e) => {
                const selectedUser = e.target.value;
                if (selectedUser === "管理者") {
                    const password = prompt("請輸入密碼以選擇管理者:");
                    if (password === "Onano_Nb") {
                        localStorage.setItem("selectedUser", selectedUser);
                    } else {
                        alert("密碼錯誤！");
                        e.target.value = ""; // 
                    }
                } else {
                    localStorage.setItem("selectedUser", selectedUser);
                }
            });

            setInterval(updateBlockStatus, 1000);
            displayDateTime();
            setInterval(displayDateTime, 1000);
        };

        function displayDateTime() {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };

            const dateTime = now.toLocaleString('zh-TW', options);
            document.getElementById('datetime').textContent = dateTime;
        }

        function updateBlockStatus() {
            const allCells = document.querySelectorAll('td');
            allCells.forEach(cell => {
                const id = cell.id;
                const colorRef = ref(db, id);
                onValue(colorRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        cell.classList.remove('green', 'red');
                        cell.classList.add(data.color);
                        if (data.color === 'red') {
                            cell.textContent = `${id} - ${data.user}`;
                        } else {
                            cell.textContent = `${id}`;
                        }
                    } else {
                        cell.classList.remove('green', 'red');
                        cell.classList.add('green');
                        cell.textContent = `${id}`;
                    }
                });
            });
        }

        function toggleColor(element) {
            const id = element.id;

            const selectedUser = finalSelectedUser || document.getElementById("userSelect").value;
            if (!selectedUser) {
                alert("請先選擇或輸入使用者名稱與時間");
                return;
            }

            const colorRef = ref(db, id);

            if (element.classList.contains('green')) {
                element.classList.remove('green');
                element.classList.add('red');
                element.textContent = `${id} - ${selectedUser}`;

                const newRecord = {
                    id: id,
                    action: '使用中',
                    user: selectedUser,
                    time: new Date().toISOString(),
                    endTime: finalEndTime ? finalEndTime.toISOString() : null
                };

                set(colorRef, {
                    color: 'red',
                    user: selectedUser,
                    endTime: finalEndTime ? finalEndTime.toISOString() : null
                });

                push(recordsRef, newRecord);

            } else if (element.classList.contains('red')) {
                element.classList.remove('red');
                element.classList.add('green');
                element.textContent = id;

                set(colorRef, { color: 'green' });

                push(recordsRef, {
                    id: id,
                    action: '空閒',
                    user: selectedUser,
                    time: new Date().toISOString()
                });
            }
        }

        function showRecords() {
            const recordList = document.getElementById("recordList");
            const carNumberInput = document.getElementById("carNumberInput");
            const userSelect = document.getElementById("userSelect");
            const selectedUser = userSelect.value;

            const carNumber = carNumberInput.value.trim().toLowerCase();

            onValue(recordsRef, (snapshot) => {
                const records = snapshot.val();
                if (!records) return;

                const filteredRecords = Object.entries(records)
                    .filter(([key, record]) => {
                        const recordDate = new Date(record.time);
                        const recordDateStr = recordDate.toISOString().split('T')[0];

                        const isCarNumberMatch = carNumber === "" || record.id.toLowerCase().includes(carNumber);
                        const isUserMatch = selectedUser === "管理者" || record.user === selectedUser;

                        return isCarNumberMatch && isUserMatch;
                    })
                    .reverse();

                recordList.innerHTML = ''; 

                filteredRecords.forEach(([key, record]) => {
                    const recordItem = document.createElement("li");
                    const recordTime = new Date(record.time);
                    const options = {
                        timeZone: 'Asia/Taipei',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };
                    const localTime = recordTime.toLocaleString('zh-TW', options);

                    recordItem.textContent = `${record.id} - ${record.action} (${record.user}) - ${localTime}`;

                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "刪除";
                    deleteButton.onclick = function() {
                        const password = prompt("請輸入密碼以刪除紀錄:");
                        if (password === "Onano_Nb") {
                            remove(ref(db, 'records/' + key)).then(() => {
                                alert("紀錄已刪除！");
                                showRecords();  
                            }).catch((error) => {
                                alert("刪除失敗：" + error);
                            });
                        } else {
                            alert("密碼錯誤！");
                        }
                    };

                    recordItem.appendChild(deleteButton);
                    recordList.appendChild(recordItem);
                });
            });
        }

        window.toggleColor = toggleColor;
        window.showRecords = showRecords;
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-image: url('https://i.meee.com.tw/445Ea5W.png');
            background-size: cover;
            background-attachment: fixed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
        }
        .green {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .red {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
        }
        .first-row td {
            width: 16.6%;
            height: 60px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .second-row td {
            width: 12.5%;
            height: 60px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        h1 {
            font-family: 'DFKai-SB', "標楷體", serif;
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }
        #datetime {
            font-size: 18px;
            font-family: 'Arial', sans-serif;
            margin-left: 20px;
        }
        select {
            margin: 20px 0;
        }
        #recordList {
            margin-top: 20px;
            padding: 0;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        button {
            cursor: pointer;
            margin-top: 10px;
        }
        #systemImage {
            display: block;
            margin: 20px auto;
            max-width: 10%;
            height: auto;
        }
        /*  */
        #newsTicker {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
        }
        #newsTicker span {
            display: inline-block;
            padding-right: 100%;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>

    <h1>
        悅城會議室預約系統
    </h1>

    <h1>
        <span id="datetime"></span>
    </h1>

    <a href="http://www.onano-nm.com/">
        <img id="systemImage" src="https://i.meee.com.tw/VFCitmP.png" alt="悅城會議室預約系統圖片" />
    </a>
<!-- 使用者選擇/輸入 + 時間 + 套用 -->
<div>
    <label for="userSelect">選擇用戶: </label>
    <select id="userSelect">
        <option value="">請選擇</option>
    </select>

    <input type="text" id="customUserInput" placeholder="或輸入名稱，例如：王大明" />
    <input type="text" id="customTimeInput" placeholder="時間，例如：0921 09:00~11:00" />
    <button onclick="applyCustomUserAndTime()">套用</button>
</div>

    <!--  -->
    <div id="newsTicker">
        <span>最新消息: 請同仁踴躍使用!!</span>
    </div>

    <h2>小型會議室(可容納4~5人)</h2>
    <table class="first-row">
        <tr>
            <td class="green" id="102" onclick="toggleColor(this)">102</td>
            <td class="green" id="103" onclick="toggleColor(this)">103</td>
            <td class="green" id="104" onclick="toggleColor(this)">104</td>
            <td class="green" id="107" onclick="toggleColor(this)">107</td>
            <td class="green" id="108" onclick="toggleColor(this)">108</td>
        </tr>
    </table>

    <h2>中型會議室(可容納6~10人)</h2>
    <table class="second-row">
        <tr>
            <td class="green" id="105" onclick="toggleColor(this)">105</td>
            <td class="green" id="106" onclick="toggleColor(this)">106</td>
            <td class="green" id="A01" onclick="toggleColor(this)">A01</td>
            <td class="green" id="A02" onclick="toggleColor(this)">A02</td>
            <td class="green" id="A03" onclick="toggleColor(this)">A03</td>
        </tr>
    </table>

    <h2>大型會議室(可容納10~12人)</h2>
    <table class="second-row">
        <tr>
            <td class="green" id="101" onclick="toggleColor(this)">101</td>
        </tr>
    </table>

    <div>
        <label for="carNumberInput">搜尋預約::</label>
        <input type="text" id="carNumberInput" placeholder="輸入會議室ID...">
    </div>

    <button onclick="showRecords()">顯示紀錄</button>

    <ul id="recordList"></ul>

</body>
</html>






